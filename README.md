# TrueNAS ZFS Unlock

[![PyPI](https://img.shields.io/pypi/v/truenas-zfs-unlock)](https://pypi.org/project/truenas-zfs-unlock/)
[![Python](https://img.shields.io/pypi/pyversions/truenas-zfs-unlock)](https://pypi.org/project/truenas-zfs-unlock/)
[![Tests](https://github.com/basnijholt/truenas-zfs-unlock/actions/workflows/test.yml/badge.svg)](https://github.com/basnijholt/truenas-zfs-unlock/actions/workflows/test.yml)
[![License](https://img.shields.io/github/license/basnijholt/truenas-zfs-unlock)](LICENSE)

Unlock encrypted ZFS datasets on TrueNAS via the API.

## Install

```bash
# With uv (recommended)
uv tool install truenas-zfs-unlock

# With pip
pip install truenas-zfs-unlock
```

## Setup

Create `~/.config/truenas-unlock/config.yaml`:

```yaml
host: 192.168.1.214:443
api_key: ~/.secrets/truenas-api-key  # file path or literal
skip_cert_verify: true

# secrets: auto  # auto (default) | files | inline

datasets:
  tank/syncthing: ~/.secrets/syncthing-key  # reads from file
  tank/photos: my-literal-passphrase        # used as-is (no such file)
```

The `secrets` mode controls how values are interpreted:
- **auto** (default): if file exists, read from it; otherwise use as literal
- **files**: always treat values as file paths
- **inline**: always treat values as literal secrets

## Usage

```bash
# Run once
truenas-zfs-unlock

# Run as daemon (every 10 seconds)
truenas-zfs-unlock --daemon

# Custom interval
truenas-zfs-unlock --daemon --interval 30

# Dry run
truenas-zfs-unlock --dry-run
```

## CLI

```bash
truenas-zfs-unlock --help
```

<!-- CODE:BASH:START -->
<!-- export NO_COLOR=1 -->
<!-- export TERM=dumb -->
<!-- export TERMINAL_WIDTH=90 -->
<!-- echo '```bash' -->
<!-- truenas-zfs-unlock --help -->
<!-- echo '```' -->
<!-- CODE:END -->

<!-- OUTPUT:START -->
<!-- ⚠️ This content is auto-generated by `markdown-code-runner`. -->

<!-- OUTPUT:END -->



## Running as a Service

### Linux (systemd)

Create a user service at `~/.config/systemd/user/truenas-zfs-unlock.service`:

```ini
[Unit]
Description=TrueNAS ZFS Unlock
After=network-online.target
Wants=network-online.target

[Service]
ExecStart=%h/.local/bin/truenas-zfs-unlock --daemon
Restart=on-failure
RestartSec=10

[Install]
WantedBy=default.target
```

Enable and start:

```bash
systemctl --user daemon-reload
systemctl --user enable --now truenas-zfs-unlock
systemctl --user status truenas-zfs-unlock

# View logs
journalctl --user -u truenas-zfs-unlock -f
```

To run at boot (even without login):

```bash
sudo loginctl enable-linger $USER
```

### macOS (launchd)

Create a launch agent at `~/Library/LaunchAgents/com.truenas-zfs-unlock.plist`:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.truenas-zfs-unlock</string>
    <key>ProgramArguments</key>
    <array>
        <string>/Users/YOUR_USERNAME/.local/bin/truenas-zfs-unlock</string>
        <string>--daemon</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <true/>
    <key>StandardOutPath</key>
    <string>/tmp/truenas-zfs-unlock.log</string>
    <key>StandardErrorPath</key>
    <string>/tmp/truenas-zfs-unlock.err</string>
</dict>
</plist>
```

Load and start:

```bash
# Replace YOUR_USERNAME in the plist first, then:
launchctl load ~/Library/LaunchAgents/com.truenas-zfs-unlock.plist

# Check status
launchctl list | grep truenas

# View logs
tail -f /tmp/truenas-zfs-unlock.log

# Stop/unload
launchctl unload ~/Library/LaunchAgents/com.truenas-zfs-unlock.plist
```

## Development

```bash
# Clone and install
git clone https://github.com/basnijholt/truenas-zfs-unlock
cd truenas-zfs-unlock
uv sync --dev

# Run tests
uv run pytest

# Run lints
uv run ruff check .
uv run mypy truenas_zfs_unlock.py
```

## Credits

Inspired by [ThorpeJosh/truenas-zfs-unlock](https://github.com/ThorpeJosh/truenas-zfs-unlock).

## License

MIT
